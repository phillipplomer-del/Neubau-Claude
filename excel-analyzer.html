<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel File Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .file-input {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border: 2px dashed #ccc;
            border-radius: 4px;
            text-align: center;
        }
        input[type="file"] {
            padding: 10px;
            font-size: 16px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #output {
            margin-top: 20px;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Excel File Analyzer for ERP Data</h1>

        <div class="warning">
            <strong>Instructions:</strong>
            <ol style="margin: 10px 0;">
                <li>Select one of the three Excel files to analyze</li>
                <li>Click "Analyze File" to see the column structure</li>
                <li>Review the output for column names, types, and recommendations</li>
                <li>Look for Artikelnummer, Projektnummer, and business rules</li>
            </ol>
        </div>

        <div class="file-input">
            <label for="fileInput">
                <strong>Select Excel File:</strong><br><br>
                <input type="file" id="fileInput" accept=".xlsx,.xlsm" />
            </label>
            <br><br>
            <button id="analyzeBtn" onclick="analyzeFile()" disabled>Analyze File</button>
            <button onclick="clearOutput()">Clear Output</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const output = document.getElementById('output');

        fileInput.addEventListener('change', function() {
            analyzeBtn.disabled = !this.files.length;
        });

        const COLUMN_KEYWORDS = {
            artikelnummer: ['art', 'item', 'artikel', 'material', 'nummer', 'itemnr', 'itemno', 'artnr'],
            projektnummer: ['proj', 'project', 'auftrag', 'order', 'projektnr', 'projnr'],
            date: ['date', 'datum', 'termin', 'deadline', 'start', 'end', 'ende'],
            quantity: ['qty', 'quantity', 'menge', 'anzahl', 'rem', 'remaining'],
            status: ['status', 'state', 'zustand'],
            customer: ['customer', 'kunde', 'client'],
            description: ['description', 'beschreibung', 'name', 'bezeichnung'],
            price: ['price', 'preis', 'cost', 'kosten'],
        };

        function detectColumnType(values) {
            const sampleSize = Math.min(100, values.length);
            const samples = values.slice(0, sampleSize);

            let numberCount = 0;
            let stringCount = 0;
            let dateCount = 0;

            for (const value of samples) {
                if (value === null || value === undefined || value === '') continue;

                if (typeof value === 'number') {
                    numberCount++;
                } else if (value instanceof Date) {
                    dateCount++;
                } else if (typeof value === 'string') {
                    if (isDateString(value)) {
                        dateCount++;
                    } else {
                        stringCount++;
                    }
                }
            }

            const total = numberCount + stringCount + dateCount;
            if (total === 0) return 'unknown';

            if (dateCount / total > 0.7) return 'date';
            if (numberCount / total > 0.7) return 'number';
            if (stringCount / total > 0.5) return 'string';

            return 'unknown';
        }

        function isDateString(str) {
            const datePatterns = [
                /^\d{4}-\d{2}-\d{2}/,
                /^\d{2}\.\d{2}\.\d{4}/,
                /^\d{2}\/\d{2}\/\d{4}/,
            ];
            return datePatterns.some(pattern => pattern.test(str));
        }

        async function analyzeFile() {
            const file = fileInput.files[0];
            if (!file) return;

            output.innerHTML = '<div class="loading">‚è≥ Analyzing file...</div>';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { cellDates: true });

                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];

                const jsonData = XLSX.utils.sheet_to_json(sheet);
                const rows = jsonData.filter(row =>
                    Object.values(row).some(val => val !== null && val !== undefined && val !== '')
                );

                const columns = rows.length > 0 ? Object.keys(rows[0]) : [];

                let result = '';
                result += '='.repeat(100) + '\n';
                result += `FILE: ${file.name}\n`;
                result += `Sheet: ${sheetName}\n`;
                result += '='.repeat(100) + '\n\n';

                result += 'BASIC INFORMATION:\n';
                result += `  Total rows: ${rows.length}\n`;
                result += `  Total columns: ${columns.length}\n`;
                result += `  Sheet names: ${workbook.SheetNames.join(', ')}\n\n`;

                result += `ALL COLUMN NAMES (${columns.length} columns):\n`;
                columns.forEach((col, idx) => {
                    const values = rows.map(row => row[col]);
                    const type = detectColumnType(values);
                    const nonNull = values.filter(v => v !== null && v !== undefined && v !== '');
                    const unique = new Set(nonNull).size;

                    result += `  ${String(idx + 1).padStart(2, ' ')}. ${col} (${type})\n`;
                    if (idx < 5 && nonNull.length > 0) {
                        const samples = nonNull.slice(0, 2).map(v => String(v).substring(0, 40)).join(', ');
                        result += `      Samples: ${samples}\n`;
                        result += `      Unique: ${unique}\n`;
                    }
                });

                result += '\n' + 'SAMPLE DATA (First 5 rows):\n';
                result += '-'.repeat(100) + '\n';

                for (let i = 0; i < Math.min(5, rows.length); i++) {
                    result += `\nRow ${i + 1}:\n`;
                    const row = rows[i];

                    Object.entries(row).forEach(([key, value]) => {
                        if (value !== null && value !== undefined && value !== '') {
                            let valueStr = String(value);
                            if (typeof value === 'number') {
                                valueStr = value % 1 === 0 ? String(Math.floor(value)) : value.toFixed(2);
                            }
                            if (valueStr.length > 60) {
                                valueStr = valueStr.substring(0, 60) + '...';
                            }
                            result += `  ${key}: ${valueStr}\n`;
                        }
                    });
                }

                result += '\n\n' + 'COLUMN ANALYSIS:\n';
                result += '-'.repeat(100) + '\n';

                // Article Number
                const articleCandidates = columns.filter(col =>
                    COLUMN_KEYWORDS.artikelnummer.some(kw => col.toLowerCase().includes(kw))
                );

                if (articleCandidates.length > 0) {
                    result += '\nPotential ARTICLE NUMBER columns:\n';
                    articleCandidates.forEach(col => {
                        const samples = rows.slice(0, 3).map(row => row[col]).filter(v => v);
                        const unique = new Set(rows.map(row => row[col]).filter(v => v)).size;
                        result += `  - ${col}\n`;
                        result += `    Sample values: ${samples.join(', ')}\n`;
                        result += `    Unique values: ${unique}\n`;
                    });
                }

                // Project Number
                const projectCandidates = columns.filter(col =>
                    COLUMN_KEYWORDS.projektnummer.some(kw => col.toLowerCase().includes(kw))
                );

                if (projectCandidates.length > 0) {
                    result += '\nPotential PROJECT NUMBER columns:\n';
                    projectCandidates.forEach(col => {
                        const samples = rows.slice(0, 3).map(row => row[col]).filter(v => v);
                        const unique = new Set(rows.map(row => row[col]).filter(v => v)).size;
                        result += `  - ${col}\n`;
                        result += `    Sample values: ${samples.join(', ')}\n`;
                        result += `    Unique values: ${unique}\n`;
                    });
                }

                // Quantities
                const qtyCandidates = columns.filter(col =>
                    COLUMN_KEYWORDS.quantity.some(kw => col.toLowerCase().includes(kw))
                );

                if (qtyCandidates.length > 0) {
                    result += '\nPotential QUANTITY columns:\n';
                    qtyCandidates.forEach(col => {
                        const values = rows.map(row => row[col]).filter(v => typeof v === 'number');
                        if (values.length > 0) {
                            const min = Math.min(...values);
                            const max = Math.max(...values);
                            const avg = values.reduce((a, b) => a + b, 0) / values.length;
                            result += `  - ${col}\n`;
                            result += `    Min: ${min}, Max: ${max}, Average: ${avg.toFixed(2)}\n`;
                        }
                    });
                }

                // Dates
                const dateCandidates = columns.filter(col =>
                    COLUMN_KEYWORDS.date.some(kw => col.toLowerCase().includes(kw))
                );

                if (dateCandidates.length > 0) {
                    result += '\nPotential DATE columns:\n';
                    dateCandidates.forEach(col => {
                        const sample = rows.find(row => row[col])?.[col];
                        result += `  - ${col}\n`;
                        result += `    Sample: ${sample}\n`;
                    });
                }

                // QuantityRem1 business rule
                if (columns.includes('QuantityRem1')) {
                    result += '\n' + '*'.repeat(100) + '\n';
                    result += 'IMPORTANT: QuantityRem1 column found (BUSINESS RULE)\n';
                    result += '*'.repeat(100) + '\n';

                    const zeroCount = rows.filter(row => row['QuantityRem1'] === 0 || row['QuantityRem1'] === '0').length;
                    const nonZeroCount = rows.filter(row => row['QuantityRem1'] > 0).length;
                    const total = rows.length;

                    result += `  Total rows: ${total}\n`;
                    result += `  Rows where QuantityRem1 = 0 (already delivered, SKIP): ${zeroCount} (${(zeroCount/total*100).toFixed(1)}%)\n`;
                    result += `  Rows where QuantityRem1 > 0 (pending delivery, INCLUDE): ${nonZeroCount} (${(nonZeroCount/total*100).toFixed(1)}%)\n`;
                    result += '\n  ACTION: Filter out rows where QuantityRem1 == 0 before processing\n';
                }

                result += '\n\n' + 'RECOMMENDATIONS:\n';
                result += '-'.repeat(100) + '\n';

                if (articleCandidates.length > 0) {
                    result += `  ARTIKELNUMMER (Article Number): Use column '${articleCandidates[0]}'\n`;
                } else {
                    result += '  ARTIKELNUMMER (Article Number): NOT FOUND - manual mapping needed\n';
                }

                if (projectCandidates.length > 0) {
                    result += `  PROJEKTNUMMER (Project Number): Use column '${projectCandidates[0]}'\n`;
                } else {
                    result += '  PROJEKTNUMMER (Project Number): NOT FOUND - manual mapping needed\n';
                }

                result += '\n='.repeat(100) + '\n';
                result += 'ANALYSIS COMPLETE\n';
                result += '='.repeat(100);

                output.innerHTML = `<div class="success">‚úÖ Analysis completed successfully!</div>`;
                output.innerHTML += `<pre>${result}</pre>`;

            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error analyzing file: ${error.message}</div>`;
                console.error(error);
            }
        }

        function clearOutput() {
            output.innerHTML = '';
            fileInput.value = '';
            analyzeBtn.disabled = true;
        }
    </script>
</body>
</html>
